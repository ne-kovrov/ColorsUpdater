<!doctype html>
<html>
  <body style="font: var(--text-sm); margin: 12px;">
    <div style="margin:0 0 16px; padding:12px 16px; background:#e6f0ff; border:1px solid #3686ff; border-radius:4px; font-size:12px; color:#152242; font-family:'Lato',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">
      Плагин обрабатывает только текущую открытую страницу
    </div>
    <div style="margin:16px 0;">
      <div style="margin-bottom:12px; padding:12px; background:#e6f0ff; border:1px solid #3686ff; border-radius:4px; color:#152242; font-size:12px; display:flex; align-items:flex-start; gap:8px; font-family:'Lato',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">
        <div style="width:16px; height:16px; background:#3686ff; border-radius:50%; flex-shrink:0; margin-top:2px; display:flex; align-items:center; justify-content:center; color:white; font-size:10px; font-weight:bold;">i</div>
        <div>Сперва запустите плагин в файле библиотеки и нажмите «Собрать каталог…» чтобы собрать актуальные цвета</div>
      </div>
      <details id="catalog-accordion">
        <summary>Каталог переменных (name,key,id,collection)</summary>
        <div style="display:flex; gap:8px; margin-bottom:16px;">
          <button id="copy">Копировать</button>
          <button id="clear">Очистить</button>
          <button id="collect">Собрать каталог из этого файла</button>
        </div>
        <textarea id="catalog" placeholder="name,key,id,collection&#10;Color/Primary/500,Var:abc...,1:123,Tokens" style="width:100%;height:180px;"></textarea>
      </details>
    </div>
    <div style="margin:16px 0;">
      <div style="font-family:'Lato',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-weight:700; font-size:16px; line-height:24px; letter-spacing:-0.2px; margin-bottom:8px; color:#1f2328;">Маппинг (styleName,variableName[,collectionName])</div>
      <textarea id="mapping" placeholder="Primary/500,Color/Primary/500&#10;Secondary/300,Color/Secondary/300,Tokens" style="width:100%;height:140px;"></textarea>
    </div>
    <div style="margin-top:20px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button id="run">Запустить</button>
      <button id="cancel">Отмена</button>
      <div id="loader" style="display:none; align-items:center; gap:12px; color:#707a95; font-size:12px; padding:8px 12px; background:#e6f0ff; border-radius:4px; border:1px solid #3686ff; font-family:'Lato',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">
        <div style="width:16px; height:16px; border:2px solid #e6f0ff; border-top:2px solid #3686ff; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <span>Обрабатываем стили...</span>
      </div>
    </div>
    <div id="err" style="margin-top:16px; padding:12px 16px; border-radius:8px; font-size:12px; white-space:pre-wrap; display:none;"></div>
    <style>
      :root {
        --font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        /* Text styles (match Figma scale approximately) */
        --text-xs: 11px/16px var(--font-family);
        --text-sm: 12px/18px var(--font-family);
        --text-md: 13px/20px var(--font-family);
        --text-lg: 14px/22px var(--font-family);
        --text-xl: 16px/24px var(--font-family);
        /* Headings */
        --heading-sm-size: 14px;
        --heading-sm-line: 20px;
        --heading-weight: 600;
        /* Colors (kept minimal, UI already uses inline colors) */
        --text-primary: #1f2328;
        --text-secondary: #666;
      }

      body {
        color: var(--text-primary);
      }
      h3 {
        font-weight: var(--heading-weight);
        font-size: var(--heading-sm-size);
        line-height: var(--heading-sm-line);
        margin: 0 0 8px;
      }
      summary {
        font-weight: var(--heading-weight);
        font-size: var(--heading-sm-size);
        line-height: var(--heading-sm-line);
        color: var(--text-primary);
      }
      /* Design System Accordion Styles */
      #catalog-accordion {
        border: none;
        border-bottom: 0.5px solid #c9d1e5;
        background: transparent;
        box-shadow: none;
        overflow: visible;
        margin: 0;
        padding: 16px 0;
      }
      
      #catalog-accordion > summary {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0;
        background: transparent;
        border: none;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-weight: 700;
        font-size: 16px;
        line-height: 24px;
        letter-spacing: -0.2px;
        color: #152242;
        list-style: none;
        outline: none;
        width: 100%;
      }
      
      #catalog-accordion > summary:hover {
        background: transparent;
        color: #152242;
      }
      
      #catalog-accordion > summary::before {
        display: none;
      }
      
      #catalog-accordion > summary::after {
        content: '';
        width: 16px;
        height: 16px;
        background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQgNkw4IDEwTDEyIDYiIHN0cm9rZT0iIzcwN2E5NSIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K') no-repeat center;
        background-size: contain;
        margin-left: auto;
        transition: transform 0.2s ease;
        flex-shrink: 0;
      }
      
      #catalog-accordion[open] > summary::after {
        transform: rotate(180deg);
      }
      
      #catalog-accordion > div {
        padding: 16px 0 0 0;
        background: transparent;
        border: none;
        margin-top: 16px;
      }
      /* Design System Input Styles */
      textarea, input, select {
        font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 24px;
        background: #ffffff;
        border: 1px solid #c9d1e5;
        border-radius: 4px;
        padding: 8px 12px 4px 12px;
        transition: all 0.2s ease;
        resize: vertical;
        min-height: 52px;
        color: #152242;
        width: 100%;
        box-sizing: border-box;
      }
      
      textarea:focus, input:focus, select:focus {
        outline: none;
        border-color: #3686ff;
        box-shadow: 0 0 0 1px #3686ff;
      }
      
      textarea:hover, input:hover, select:hover {
        border-color: #c9d1e5;
      }
      
      textarea::placeholder, input::placeholder {
        color: #b8c1d6;
        font-weight: 400;
        font-size: 16px;
        line-height: 24px;
      }
      
      textarea:disabled, input:disabled, select:disabled {
        background: #e4e9f6;
        border-color: #e4e9f6;
        color: #b8c1d6;
      }
      
      textarea:disabled::placeholder, input:disabled::placeholder {
        color: #b8c1d6;
      }
      
      /* Figma Button Styles - XS Size */
      button {
        font-family: 'Lato', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-weight: 700;
        font-size: 12px;
        line-height: 16px;
        letter-spacing: -0.2px;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        min-height: 28px;
        text-decoration: none;
        position: relative;
        overflow: hidden;
        white-space: nowrap;
      }
      
      /* Primary Button (from Figma) */
      button#run {
        background: #0468ff;
        color: #ffffff;
      }
      
      button#run:hover:not(:disabled) {
        background: #0661ec;
      }
      
      button#run:active {
        background: #075ad9;
      }
      
      button#run:disabled {
        background: #e4e9f6;
        color: #b8c1d6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      /* Secondary Buttons (from Figma) */
      button#cancel, button#copy, button#clear, button#collect {
        background: #e6f0ff;
        color: #0661ec;
      }
      
      button#cancel:hover:not(:disabled), button#copy:hover:not(:disabled), button#clear:hover:not(:disabled), button#collect:hover:not(:disabled) {
        background: #d1e7ff;
      }
      
      button#cancel:active, button#copy:active, button#clear:active, button#collect:active {
        background: #b8d4ff;
      }
      
      button#cancel:disabled, button#copy:disabled, button#clear:disabled, button#collect:disabled {
        background: #e4e9f6;
        color: #b8c1d6;
        cursor: not-allowed;
      }
      
      /* Focus states for all buttons */
      button:focus {
        outline: none;
        box-shadow: 0 0 0 2px #3686ff;
      }
      
      button:focus:not(:disabled) {
        box-shadow: 0 0 0 2px #3686ff;
      }
      
      /* Error Message Styles */
      #err {
        display: none;
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 12px;
        white-space: pre-wrap;
        border: 1px solid;
      }
      
      #err.error {
        display: block;
        background: #fef2f2;
        border-color: #fecaca;
        color: #dc2626;
      }
      
      #err.success {
        display: block;
        background: #f0fdf4;
        border-color: #bbf7d0;
        color: #16a34a;
      }
      
      #err.warning {
        display: block;
        background: #fffbeb;
        border-color: #fed7aa;
        color: #ea580c;
      }
      
      #err.info {
        display: block;
        background: #e6f0ff;
        border-color: #3686ff;
        color: #152242;
      }
      small, .hint, .muted {
        font: var(--text-xs);
        color: var(--text-secondary);
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    <script>
      const $ = (id) => document.getElementById(id);
      const mapping = $('mapping');
      const catalog = $('catalog');
      const err = $('err');
      const loader = $('loader');
      const runBtn = $('run');
      const catalogAccordion = $('catalog-accordion');
      
      // Управление состоянием аккордеона
      function initAccordionState() {
        // Проверяем, есть ли сохраненное состояние
        const savedState = localStorage.getItem('catalog-accordion-open');
        
        if (savedState === null) {
          // Первый запуск - открываем аккордеон
          catalogAccordion.open = true;
        } else {
          // Восстанавливаем сохраненное состояние
          catalogAccordion.open = savedState === 'true';
        }
      }
      
      function saveAccordionState() {
        localStorage.setItem('catalog-accordion-open', catalogAccordion.open.toString());
      }
      
      // Инициализируем состояние аккордеона
      initAccordionState();
      
      // Сохраняем состояние при изменении
      catalogAccordion.addEventListener('toggle', saveAccordionState);
      
      // Функция для скрытия лоадера
      function hideLoader() {
        loader.style.display = 'none';
        runBtn.disabled = false;
        runBtn.textContent = 'Запустить';
      }
      $('run').onclick = () => {
        err.textContent = '';
        const csv = mapping.value || '';
        const cat = catalog.value || '';
        if (!csv.trim()) {
          err.textContent = 'Вставьте CSV маппинга (styleName,variableName[,collectionName]).';
          err.className = 'error';
          return;
        }
        
        // Показываем лоадер и блокируем кнопку
        loader.style.display = 'flex';
        runBtn.disabled = true;
        runBtn.textContent = 'Обрабатываем...';
        
        parent.postMessage({ pluginMessage: { type: 'run', mappingCsv: csv, catalogCsvOrJson: cat } }, '*');
      };
      $('cancel').onclick = () => parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
      $('collect').onclick = () => {
        console.log('Кнопка "Собрать каталог" нажата');
        err.textContent = 'Собираем каталог...';
        err.className = 'info';
        console.log('Отправляем сообщение в плагин:', { type: 'collect-catalog' });
        parent.postMessage({ pluginMessage: { type: 'collect-catalog' } }, '*');
        console.log('Сообщение отправлено');
      };
      $('copy').onclick = () => {
        const catalogText = catalog.value;
        if (!catalogText.trim()) {
          err.textContent = 'Каталог пуст. Сначала соберите каталог или вставьте данные.';
          err.className = 'error';
          return;
        }
        try {
          // Выделяем текст в textarea
          catalog.select();
          catalog.setSelectionRange(0, catalogText.length);
          
          // Пытаемся скопировать через execCommand
          const success = document.execCommand('copy');
          
          if (success) {
            err.textContent = 'Каталог скопирован в буфер обмена!';
            err.className = 'success';
            setTimeout(() => {
              err.textContent = '';
              err.className = '';
            }, 2000);
          } else {
            // Fallback: показываем текст для ручного копирования
            err.textContent = 'Автокопирование недоступно. Выделите и скопируйте текст вручную (Ctrl+C).';
            err.className = 'error';
            catalog.focus();
            catalog.select();
          }
        } catch (e) {
          err.textContent = 'Не удалось скопировать. Выделите и скопируйте текст вручную (Ctrl+C).';
          err.className = 'error';
          catalog.focus();
          catalog.select();
        }
      };
      $('clear').onclick = () => {
        catalog.value = '';
        mapping.value = '';
        parent.postMessage({ pluginMessage: { type: 'clear-data' } }, '*');
        err.textContent = 'Данные очищены.';
        err.className = 'success';
        setTimeout(() => {
          err.textContent = '';
          err.className = '';
        }, 2000);
      };
      // Загружаем сохраненные данные при запуске
      parent.postMessage({ pluginMessage: { type: 'load-data' } }, '*');

      // Автоматически сохраняем каталог при редактировании
      catalog.addEventListener('input', () => {
        parent.postMessage({ pluginMessage: { type: 'save-catalog', text: catalog.value } }, '*');
      });

      // Автоматически сохраняем маппинг при редактировании
      mapping.addEventListener('input', () => {
        parent.postMessage({ pluginMessage: { type: 'save-mapping', text: mapping.value } }, '*');
      });

      window.addEventListener('message', (e) => {
        console.log('UI получил сообщение:', e);
        console.log('Получено сообщение от плагина:', e.data);
        const msg = e.data.pluginMessage || {};
        console.log('Тип сообщения:', msg.type);
        if (msg.type === 'catalog-result') {
          console.log('Получен результат каталога, длина:', msg.text?.length || 0);
          catalog.value = msg.text || '';
          // Сохраняем каталог в clientStorage
          parent.postMessage({ pluginMessage: { type: 'save-catalog', text: catalog.value } }, '*');
          err.textContent = 'Каталог собран успешно!';
          err.className = 'success';
          setTimeout(() => {
            err.textContent = '';
            err.className = '';
          }, 2000);
        } else if (msg.type === 'catalog-loaded') {
          console.log('Загружен сохраненный каталог, длина:', msg.text?.length || 0);
          catalog.value = msg.text || '';
        } else if (msg.type === 'mapping-loaded') {
          console.log('Загружен сохраненный маппинг, длина:', msg.text?.length || 0);
          mapping.value = msg.text || '';
        } else if (msg.type === 'data-loaded') {
          console.log('Загружены сохраненные данные');
          if (msg.catalog) catalog.value = msg.catalog;
          if (msg.mapping) mapping.value = msg.mapping;
        } else if (msg.type === 'success') {
          console.log('Успех:', msg.detail);
          hideLoader();
          err.textContent = msg.detail || 'Успешно выполнено';
          err.className = 'success';
          setTimeout(() => {
            err.textContent = '';
            err.className = '';
          }, 5000);
        } else if (msg.type === 'warning') {
          console.warn('Предупреждение:', msg.detail);
          hideLoader();
          err.textContent = msg.detail || 'Предупреждение';
          err.className = 'warning';
          setTimeout(() => {
            err.textContent = '';
            err.className = '';
          }, 5000);
        } else if (msg.type === 'error') {
          console.error('Ошибка от плагина:', msg.detail);
          hideLoader();
          err.textContent = msg.detail || 'Ошибка';
          err.className = 'error';
        }
      });
    </script>
  </body>
</html>